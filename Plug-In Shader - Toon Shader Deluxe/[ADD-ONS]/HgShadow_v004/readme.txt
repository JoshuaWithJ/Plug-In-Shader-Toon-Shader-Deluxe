HgShadow.fx ver0.0.4

｢とことん高品位な影を追求してみよう!｣という方針で作成した影生成エフェクト。
以下のような特徴があります。

・シャドウマップとしてCFSUSM(Cascaded Fixation Space Uniform Shadow Maps：分割空間固定正方シャドウマップ)と
  CLSPSM(Cascaded Light Space Perspective Shadow Maps：分割ライト空間透視シャドウマップ)の2種類を実装しています。
  状況に応じてどちらか一方をパラメータで切り替えて使用します。

・CFSUSMは1つのオフスクリーンを4分割して,パース無しのマップをそれぞれ近景用から遠景用に空間固定で配置したシャドウマップです。
  空間固定なのでカメラ操作による影境界のちらつきが起こりません。ただマップ中心位置から離れると影の精度が悪くなります。
  パラメータ調整がしやすく初心者向けのマップです。(ちなみにCFSUSMというのは作者が勝手に名付けた造語です)

・CLSPSMは1つのオフスクリーンを4分割して,CSM法に基づきカメラ視錐台を分割して、それぞれを近景用から遠景用に
  LSPSM法に基づくパース掛けしたマップを配置したシャドウマップです。
  パースバランスが良く近景・遠景共に良好な影が得られる高精度なマップですが、シーンに応じて適切なパラメータを与えないと
  エイリアス(影境界のギザギザ)が発生してカメラ操作によるちらつきが目立ってしまします。
  パラメータ調整にはコツが必要で、中・上級者向けのマップです。

・MMD標準シャドウマップを最近景または最遠景のマップとして、本エフェクトのシャドウマップと組み合わせて
  使用することで、より広範囲・高精度な影生成が可能(MMM標準シャドウマップは未対応)。

・シャドウマップをより高精度化するためのパラメータ調整機能と、調整を支援するエフェクトを付属。

・ソフトシャドウに対応、ぼかしの強さを遮蔽距離,深度,光線が当たる角度,視野角によって調整しており、
  より自然に近いぼかし方になっています。

・拙作VolumeShadowとの供用が可能です。VolumeShadowの影もソフトシャドウの対象になります。

・かなり重いです。



■動作環境
SM3.0対応グラフィックボードが必須になります。
MMEv0.37, MMEv0.37x64，MMMv125d，MMM64v125dで動作確認を行っています。旧バージョンでは動作しない可能性があります。



■使用方法
(1)エフェクトファイルに直接入力するパラメータは HgShadow_Header.fxh にまとめてあります。予め必要に応じて変更してください。
   特にシャドウマップの種類 CFSUSM or CLSPSM どちらを選ぶかで後のパラメータ調整方法が変わってきます。
   デフォルトのシャドウマップは CFSUSM になっています。CLSPSM にするにはパラメータの切り替えが必要です。
(2)MMD/MMMの全体のセルフ影設定はONにして下さい。モデル・アクセの影もONにして下さい。
(3)HgShadow.xをMMDにロードしてください。MMMではHgShadow.fxを直接ロードします。
(4)HgShadow.xの描画順序を出来るだけ前の方にしてください。MMMではHgShadow.xより前の順序のモデルは正常に描画されません。
(5)描画するすべてのモデル・アクセサリに以下のエフェクトファイルを適用します。
  MMEの場合
    ｢MMEffect｣→｢エフェクト割当｣のMainタブより影描画するすべてのモデル・アクセサリを選択して full_HgShadow.fx を適用します。
  MMMの場合
    full_HgShadow_MMM.fx をMMMにロードして、メインの｢エフェクト割り当て｣より影描画する全モデル・アクセサリに適用。
    (対応しているのはライト1のみ、ライト2,ライト3は標準の影が描画されます。)
  ※スカイドームなど影生成が不要のモデルには適用する必要はありません。
(6)HgShadow.xのアクセサリパラメータより以下の操作が可能です。
  MMEの場合
    X,Y,Z,Rz : シャドウマップを最適化するためのパラメータ(後述)
    Si : ソフトシャドウによる影のぼかし度
    Tr : 遮蔽距離によってぼかしの強さを変える度合いを調整します
    Rx : 影の濃度変更( Rx+1 が設定濃度、-1で影が消えます )
    Ry(CFSUSMの場合) : シャドウマップを最適化するためのパラメータ(後述)
    Ry(CLSPSMの場合) : 近傍影調整パラメータ -1～+1で設定
                       大きくするとちらつきのある近傍影を除去できます。ただし消えて欲しくない近傍影まで消えてしまうので要調整
  MMMの場合
    MMMではHgShadow.fxのエフェクトプロパティより同様の操作・設定が行えます。



■PMD・PMXの組み込みコントロールモーフについて
影生成するモデルがPMD・PMXの場合はモデルにコントロール用のダミーモーフを追加することで、モデル毎に個別の
調整が出来るようになります。対応しているモーフ名は以下の通りです。

   ShadowBlur+ : モデルの影のぼかし度を上げます
   ShadowBlur- : モデルの影のぼかし度を下げます
   ShadowDen+  : モデルの影の濃度を上げます
   ShadowDen-  : モデルの影の濃度を下げます

   ※｢Option｣フォルダにあるPMDEスクリプト｢コントロールモーフ追加.cx｣を使って,これらのモーフを一括追加することが出来ます。



■MMD標準シャドウマップの使用について
このエフェクトではMMD標準シャドウマップを最近景または最遠景のマップとして、CFSUSM,CLSPSMシャドウマップの適用範囲外を
補完することが出来ます。デフォルトでは最遠景のマップとして使用するように設定されています。より広範囲・高精度な
影生成を行うには次のようなパラメータ設定が必要です。
(1)最遠景マップとして使用する場合
   ①HgShadow_Header.fxhのパラメータで UseMMDShadowMap 2 にします(デフォルト設定)。
   ②MMDの｢セルフシャドウ操作｣パネルより遠景優先の設定にします(mode2, 影範囲9800以上がオススメ)
(2)最近景マップとして使用する場合
   ①HgShadow_Header.fxhのパラメータで UseMMDShadowMap 1 にします。
   ②MMDの｢セルフシャドウ操作｣パネルより近景優先の設定にします(mode1, 影範囲5000以下がオススメ)
     最近景の場合はmode2にするとCFSUSM,CLSPSMマップを全て上書きしてしまうので必ずmode1にすること

※MMMでは標準シャドウマップの使用は未対応です。CFSUSM,CLSPSMシャドウマップのみで必要な領域をカバーしてください。



■シャドウマップパラメータの最適化について
それぞれのシーンに合わせてより高品位な影を得るにはシャドウマップパラメータの最適化が必要になります。
シャドウマップ最適化設定に必要な操作パラメータは以下の通りです。

(1)シャドウマップがCFSUSMの場合

  MMEの場合、HgShadow.xのアクセサリパラメータより
    X,Y,Z : アクセサリの座標がシャドウマップの中心位置になります。座標位置はボーンにアサインした場合も
            アサイン後の位置が中心座標になります。中心位置から離れると影の精度が悪くなります。
            シーンに応じて描画したい対象の中心に移動させてください。
    Rz : シャドウマップ参照範囲内になる最遠値を調整、影描画する範囲をここで設定します。
         HgShadow_Header.fxhで初期値 ShadowViewFar(デフォルト1000) を設定して ShadowViewFar＋Rz がマップの適用範囲になります。
         遠方まで表示されているシーンではここを上げないと遠方影が表示されません。
         逆に近景のみのシーンではここを下げることでマップの解像度を高くできます。
    Ry : シャドウマップを分割する際の各マップの割合を調整、-1 ～ +1 で設定します。
         近景の精度を良くしたい時はマイナス値に、遠景の精度を良くしたい時はプラス値にしてください。

  MMMの場合、HgShadow.fxのエフェクトプロパティより
    マップ範囲  : MMEの ShadowViewFar＋Rz と同じ設定になります
    CascadParam : MMEの Ry と同じ設定になります

(2)シャドウマップがCLSPSMの場合

  MMEの場合、HgShadow.xのアクセサリパラメータより
    X  : シャドウマップを適用するカメラからの距離の最近値(Near値)を調整、
         HgShadow_Header.fxhで初期値 ShadowViewNear(デフォルト2)を設定して ShadowViewNear＋X がNear値になります。
         このパラメータはシャドウマップの精度に最も大きな影響を与えます。
         ズームアップ以外の時は X=5～10 程度にしておく方が近景の精度が高くなります。
         ただしズームアップでオブジェクトの距離がNear値以下になると極端に精度が悪くなるので要注意。
         遠景のみの表示では画面に表示されているモデル最近深度の2/3程度にすると良い感じになります。
    Y  : シャドウマップを適用するカメラからの距離の最遠値(Far値)を調整、
         HgShadow_Header.fxhで初期値 ShadowViewFar(デフォルト1000) を設定して ShadowViewFar＋Y がFar値になります。
         遠方まで表示されているシーンではここを上げないと遠方影が表示されません。
         逆に近景のみのシーンではここを下げることでマップの解像度を高くできます。
    Z  : シャドウマップを分割するカメラ距離を調整、-1 ～ +1 で設定します。
         0の時はCSM法に基づく分割方法になっています。大きくするとNear～Farの間を均等分割近づくように
         分割幅が割り振られ、小さくするとより近景に多くのマップリソースを割くように割り振られます。
    Rz : 分割した個々のマップのパース度を調整します、-1 ～ +1 で設定します。
         0の時はLSPSM法に基づいたパース調整になっています。大きくするとパースの掛かり具合が弱くなり
         小さくするとパースの掛かりが強くなります。実際は遠景の描画域ではほとんど変化はないので
         近景のズームアップしたモデルのマップ解像度を調整する時に使用します。

  MMMの場合、HgShadow.fxのエフェクトプロパティより
    Near値      : MMEの ShadowViewNear＋X と同じ設定になります
    Far値       : MMEの ShadowViewFar＋Y と同じ設定になります
    CascadParam : MMEの Z と同じ設定になります
    PersParam   : MMEの Rz と同じ設定になります

  ※シャドウマップパラメータの最適化は慣れないと難しいので、
    最初のうちはNear値とFar値のみで調整した方が良いかもしれません。



■シャドウマップテスト用エフェクトについて
このエフェクトにはシャドウマップの精度を検査するためのテスト用エフェクトが付属されています。
｢Option｣フォルダにある以下のエフェクトを使用することでシャドウマップの最適パラメータ値を見つけやすくなります。

(1)HgShadow_TestAliasingError.fxについて
   影生成時のAliasingErrorを可視化するエフェクトです。AliasingErrorというのはシャドウマップの1つのピクセルに対し、
   それを参照する画面上のピクセル数との割合を数値化したもので、この値が1以上になるとエイリアス(影境界のギザギザ)
   が発生します。シャドウマップの精度を測る目安になっています。
   このAliasingErrorが画面上のほとんどの領域で1以下になっていれば、｢パラメータは最適である｣と判断できます。

   使用方法(HgShadowがすでに設定されている状態で)
    ①HgShadow_TestAliasingError.xをMMDにロードしてください。MMMではHgShadow_TestAliasingError.fxを直接ロードします。
    ②描画順序はHgShadow.xの後にしてください。
    ③画面上にAliasingErrorの値が色分けされた状態で表示されます。緑色が1で赤味が多いほどAliasingError値が高く
      シャドウマップの精度が悪いことを示しています。HgShadow.xのパラメータを変更して画面全体の色を出来る限り
      緑～青の範囲に収まるように調整します。画面左に凡例が表示されているので参考にしてください。
    ④画面上に表示されるグリッドは(初期状態では)1マスでシャドウマップの16×16ピクセルに相当しています。
    ⑤HgShadow_TestAliasingError.xのSi,Trでグリッド幅,表示色透過値を変更できます。
    ⑥パラメータ調整が済んだら｢表示｣チェックを外して非表示にしてください。影の精度は調整前に比べて向上しているはずです。

(2)HgShadow_TestViewShadowmap.fxについて
   本エフェクトで作成されたCFSUSM,CLSPSMシャドウマップを可視化するエフェクトです。
   MMDのShift+Gで表示される標準シャドウマップと基本的に同じ機能です。

   使用方法(HgShadowがすでに設定されている状態で)
    ①HgShadow_TestViewShadowmap.xをMMDにロードしてください。MMMではHgShadow_TestViewShadowmap.fxを直接ロードします。
    ②描画順序は出来るだけ後ろの方にしてください。
    ③画面右上にシャドウマップが表示されます。
    ④HgShadow_TestViewShadowmap.xのSi,Trで表示シャドウマップのサイズ変更と表示色透過値を変更できます。

(3)MMD_MMM_TestAliasingError.fxについて
   MMD・MMM標準のシャドウマップのAliasingErrorを可視化します。HgShadowとは直接関係のない単なるオマケです。
   標準シャドウマップのパラメータ設定時にご利用ください。使い方はHgShadow_TestAliasingError.fxと同じです。



■VolumeShadowとの供用について
このエフェクトではVolumeShadow.fxによるシャドウボリュームの影を本エフェクトで生成された影と供用することが出来ます。
供用設定を行うとVolumeShadowの生成影は本エフェクトの生成影と合成され、共にソフトシャドウの処理を行い出力されます。
   使用方法(HgShadowがすでに設定されている状態で)
    ①VolumeShadow用モデルにシャドウボリューム追加のモデル変更をします。変更方法はVolumeShadowのreadme.txtを参照ください。
    ②HgShadow_Header.fxh のパラメータで WithVolumeShadow 1 にします。
    ③VolumeShadow.xとシャドウボリューム追加モデルをMMDにロードします。
    ④VolumeShadow.xの描画順序はHgShadow.xの後にしてください。
    ⑤｢MMEffect｣→｢エフェクト割当｣の｢HgS_SMap｣タブよりシャドウボリューム追加モデルを選択して非表示設定にします。
    ⑥後は通常のHgShadow設定と同じです。シャドウボリューム追加モデルにもfull_HgShadow.fxを適用します。
   ※VolumeShadowで生成された影はソフトシャドウで遮蔽距離に応じたぼかし調整することは出来ません。均一のぼかしになります。



■他のシェーダエフェクトの改変方法について
  既存のシェーダエフェクトに対応させるには、シェーダエフェクトファイルの変更が必要になります。
   ①HgShadow_ObjHeader.fxhをシェーダエフェクトのフォルダにコピーします。
   ②full_HgShadow.fx,full_HgShadow_MMM.fxの改変箇所と同じ変更を各シェーダエフェクトで行います。
     変更箇所についてはfull_HgShadow.fx,full_HgShadow_MMM.fxのコメントに書いてあるので参考にしてください。



■技術情報
本エフェクト作成にあたり以下のサイトを参考にさせていただきました。
LSPSMについて：http://www.cg.tuwien.ac.at/research/vr/lispsm/
CSMについて：http://developer.download.nvidia.com/SDK/10.5/opengl/src/cascaded_shadow_maps/doc/cascaded_shadow_maps.pdf



■更新履歴
v0.0.4  2014/7/27   分割空間固定シャドウマップ(CFSUSM)を追加,デフォ設定にした(CLSPSMとはパラメータスイッチで切り替え可)
                    分割マップの境界付近をブレンドしてマップ精度が滑らかに推移するようにした
                    32bit版MMEにおいて初期パラメータでエラーが出ないようにした
                    MMMのパラメータ設定方法に関する内部仕様の変更
v0.0.3  2014/7/10   シャドウマップマルチサンプルの取り扱いの間違いを修正
                    遮蔽判定方法の見直しと精度向上のための細かい修正
                    影濃度の計算方法を再修正
v0.0.2  2014/7/5    コントロールモーフによるモデル毎の個別調整が出来る機能追加
                    ぼかし時の境界判定処理方法を修正
                    影濃度の計算方法を一部修正
v0.0.1  2014/6/30   初回版公開



■免責事項
ご利用・改変・二次配布は自由にやっていただいてかまいません。連絡も不要です。
ただしこれらの行為は全て自己責任でやってください。
このプログラム使用により、いかなる損害が生じた場合でも当方は一切の責任を負いません。


by 針金P
Twitter : @HariganeP


